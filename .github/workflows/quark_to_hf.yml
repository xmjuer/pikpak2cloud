name: System Log Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

jobs:
  sync_service:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Env
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Deps
      run: |
        pip install psycopg2-binary huggingface_hub requests
        sudo apt-get update && sudo apt-get install -y aria2

    - name: Process Data Stream
      env:
        DB_CONNECT: ${{ secrets.DB_CONNECT }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_REPO_ID: ${{ secrets.HF_REPO_ID }}
      run: |
        python <<EOF
        import os
        import psycopg2
        import subprocess
        from huggingface_hub import HfApi
        from urllib.parse import unquote

        # === 隐蔽配置 ===
        TABLE = "sys_logs"      # 表名
        COL_URL = "payload"     # 链接字段
        COL_STATUS = "level"    # 状态字段
        
        # 状态映射
        ST_PENDING = "info"     # 待处理
        ST_PROCESS = "warn"     # 处理中
        ST_DONE = "debug"       # 完成
        # ===============

        db_url = os.environ.get("DB_CONNECT")
        hf_token = os.environ.get("HF_TOKEN")
        repo_id = os.environ.get("HF_REPO_ID")

        print("System Diagnostics Started...")
        try:
            conn = psycopg2.connect(db_url)
            cur = conn.cursor()

            # 1. 查找 'info' 级别的日志 (其实是下载任务)
            cur.execute(f'SELECT id, {COL_URL} FROM "{TABLE}" WHERE "{COL_STATUS}" = %s LIMIT 1', (ST_PENDING,))
            row = cur.fetchone()
            
            if row:
                task_id, file_url = row
                print(f"Analyzing Log ID: {task_id}")
                
                # 2. 标记为 'warn' (进行中)
                cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_PROCESS, task_id))
                conn.commit()
                
                # 文件名处理
                try:
                    filename = unquote(file_url.split('/')[-1].split('?')[0])
                    if not filename or len(filename) > 200: filename = f"data_{task_id}.bin"
                except:
                    filename = f"data_{task_id}.bin"
                
                print(f"Syncing object: {filename}")

                # 3. Aria2 下载
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                cmd = [
                    "aria2c", "-x", "16", "-s", "16", "-k", "1M",
                    "--user-agent", user_agent, "-o", filename, file_url
                ]
                
                result = subprocess.run(cmd)
                
                if result.returncode == 0 and os.path.exists(filename):
                    f_size = os.path.getsize(filename)
                    if f_size > 13 * 1024 * 1024 * 1024:
                         print("Buffer overflow (File too large).")
                         exit(1)

                    # 4. 上传
                    print("Archiving to secure storage...")
                    api = HfApi(token=hf_token)
                    try:
                        api.upload_file(
                            path_or_fileobj=filename,
                            path_in_repo=filename,
                            repo_id=repo_id,
                            repo_type="dataset"
                        )
                        print("Archive Success.")
                        
                        # 5. 标记为 'debug' (完成)
                        cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_DONE, task_id))
                        conn.commit()
                        os.remove(filename)
                        
                    except Exception as e:
                        print(f"Archive Error: {e}")
                        cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                        conn.commit()
                else:
                    print("Sync failed (Source unavailable).")
                    cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                    conn.commit()
            else:
                print("System Idle (No new logs).")
            
            cur.close()
            conn.close()

        except Exception as e:
            print(f"Kernel Error: {e}")
            exit(1)
        EOF
