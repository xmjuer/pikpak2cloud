name: Quark to HuggingFace

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '*/30 * * * *' # æ¯30åˆ†é’Ÿè¿è¡Œ

jobs:
  transfer_job:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies
      run: |
        pip install psycopg2-binary huggingface_hub requests
        sudo apt-get update && sudo apt-get install -y aria2

    - name: Run Transfer Script Auto-Detect
      env:
        DB_CONNECT: ${{ secrets.DB_CONNECT }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        # ã€é‡è¦ã€‘è¯·ç¡®è®¤è¿™é‡Œçš„ ID æ˜¯æ­£ç¡®çš„ï¼šç”¨æˆ·å/æ•°æ®é›†åç§°
        HF_REPO_ID: ${{ secrets.HF_REPO_ID }} 
        # å¦‚æœä½ æ²¡åœ¨ Secrets é‡Œè®¾ç½® HF_REPO_IDï¼Œå¯ä»¥ç›´æ¥åœ¨ä¸‹é¢æŠŠ os.environ.get æ¢æˆä½ çš„å­—ç¬¦ä¸²
        # ä¾‹å¦‚: repo_id = "zy668/aliss"
      run: |
        python <<EOF
        import os
        import psycopg2
        import subprocess
        from huggingface_hub import HfApi
        from urllib.parse import unquote

        # 1. è·å–é…ç½®
        db_url = os.environ.get("DB_CONNECT")
        hf_token = os.environ.get("HF_TOKEN")
        
        # ä¼˜å…ˆè¯»å– Secrets é‡Œçš„ HF_REPO_IDï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç¡¬ç¼–ç ï¼ˆè¯·ä¿®æ”¹æ­¤å¤„å…œåº•ï¼‰
        repo_id = os.environ.get("HF_REPO_ID") or "zy668/aliss" 

        print("ğŸš€ è¿æ¥æ•°æ®åº“...")
        try:
            conn = psycopg2.connect(db_url)
            cur = conn.cursor()
            
            # --- è‡ªåŠ¨ä¾¦æµ‹è¡¨å (è§£å†³ relation does not exist é—®é¢˜) ---
            print("æ­£åœ¨æ‰«ææ•°æ®åº“è¡¨ç»“æ„...")
            cur.execute("SELECT table_name FROM information_schema.tables WHERE table_schema = 'public'")
            all_tables = [row[0] for row in cur.fetchall()]
            print(f"ğŸ“ å½“å‰æ•°æ®åº“ä¸­çš„è¡¨: {all_tables}")

            target_table = None
            # ä¼˜å…ˆçº§åŒ¹é…ï¼štask -> tasks -> Task -> åŒ…å«taskçš„è¡¨
            if 'task' in all_tables: target_table = 'task'
            elif 'tasks' in all_tables: target_table = 'tasks'
            elif 'Task' in all_tables: target_table = 'Task'
            else:
                for t in all_tables:
                    if 'task' in t.lower():
                        target_table = t
                        break
            
            if not target_table:
                print("âŒ ä¸¥é‡é”™è¯¯: æ²¡æ‰¾åˆ°ä»»ä½•åƒ 'task' çš„è¡¨ã€‚")
                print("è¯·å›åˆ° Directus -> è®¾ç½® -> æ•°æ®æ¨¡å‹ï¼Œç¡®è®¤ä½ åˆ›å»ºäº†æ¨¡å‹ã€‚")
                exit(1)
            
            print(f"âœ… é”å®šè¡¨å: {target_table}")
            # ----------------------------------------------------

            # 2. æŸ¥è¯¢ä»»åŠ¡ (æ”¯æŒ status ä¸º pending, å¾…å¤„ç†, published)
            # ä½¿ç”¨åŒå¼•å· "{target_table}" ä»¥å…¼å®¹å¤§å°å†™æ•æ„Ÿçš„è¡¨å
            query_sql = f'SELECT id, url FROM "{target_table}" WHERE status IN (\'pending\', \'å¾…å¤„ç†\', \'published\') LIMIT 1'
            cur.execute(query_sql)
            row = cur.fetchone()
            
            if row:
                task_id, file_url = row
                print(f"ğŸ¯ å‘ç°ä»»åŠ¡ ID: {task_id}")
                print(f"ğŸ”— é“¾æ¥: {file_url}")
                
                # 3. æ›´æ–°çŠ¶æ€ä¸º processing
                update_sql = f'UPDATE "{target_table}" SET status = \'processing\' WHERE id = %s'
                cur.execute(update_sql, (task_id,))
                conn.commit()
                
                # æå–æ–‡ä»¶å
                try:
                    filename = unquote(file_url.split('/')[-1].split('?')[0])
                    if not filename or len(filename) > 200:
                         filename = f"file_{task_id}.bin"
                except:
                    filename = f"file_{task_id}.bin"
                
                print(f"ğŸ“‚ ç›®æ ‡æ–‡ä»¶å: {filename}")

                # 4. Aria2 ä¸‹è½½ (ä¼ªè£… User-Agent é˜²æ­¢ 403)
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                cmd = [
                    "aria2c", 
                    "-x", "16", "-s", "16", "-k", "1M",
                    "--user-agent", user_agent,
                    "-o", filename, 
                    file_url
                ]
                
                print("â¬‡ï¸ å¼€å§‹ä¸‹è½½...")
                result = subprocess.run(cmd)
                
                if result.returncode == 0 and os.path.exists(filename):
                    file_size = os.path.getsize(filename)
                    print(f"âœ… ä¸‹è½½æˆåŠŸ! å¤§å°: {file_size / 1024 / 1024:.2f} MB")
                    
                    # 5. ä¸Šä¼  Hugging Face
                    print(f"â¬†ï¸ æ­£åœ¨ä¸Šä¼ åˆ° Dataset: {repo_id} ...")
                    api = HfApi(token=hf_token)
                    try:
                        api.upload_file(
                            path_or_fileobj=filename,
                            path_in_repo=filename,
                            repo_id=repo_id,
                            repo_type="dataset"
                        )
                        print("ğŸ‰ ä¸Šä¼ æˆåŠŸ!")
                        
                        # 6. æ ‡è®°å®Œæˆ
                        done_sql = f'UPDATE "{target_table}" SET status = \'done\' WHERE id = %s'
                        cur.execute(done_sql, (task_id,))
                        conn.commit()
                        
                        os.remove(filename) # æ¸…ç†
                        
                    except Exception as upload_err:
                        print(f"âŒ ä¸Šä¼ å¤±è´¥: {upload_err}")
                        err_sql = f'UPDATE "{target_table}" SET status = \'error_upload\' WHERE id = %s'
                        cur.execute(err_sql, (task_id,))
                        conn.commit()
                else:
                    print("âŒ ä¸‹è½½å¤±è´¥! è¯·æ£€æŸ¥ AList/å¤¸å…‹ é“¾æ¥æ˜¯å¦æœ‰æ•ˆæˆ–è¿‡æœŸã€‚")
                    fail_sql = f'UPDATE "{target_table}" SET status = \'error_download\' WHERE id = %s'
                    cur.execute(fail_sql, (task_id,))
                    conn.commit()
            else:
                print("ğŸ’¤ æš‚æ— å¾…å¤„ç†ä»»åŠ¡ (No pending tasks)")
            
            cur.close()
            conn.close()

        except Exception as e:
            print(f"âŒ è„šæœ¬å‘ç”Ÿå¼‚å¸¸: {e}")
            exit(1)
        EOF
