name: Aå°çŒªä½©å¥‡

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *' # é»˜è®¤åŠå°æ—¶ï¼Œä¿æŒä¸å˜

jobs:
  sync_service:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Env
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Deps
      run: |
        pip install psycopg2-binary huggingface_hub requests
        sudo apt-get update && sudo apt-get install -y aria2

    - name: Process Stream
      id: transfer
      env:
        DB_CONNECT: ${{ secrets.DB_CONNECT }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_REPO_ID: ${{ secrets.HF_REPO_ID }}
      run: |
        python <<EOF
        import os
        import psycopg2
        import subprocess
        from huggingface_hub import HfApi
        from urllib.parse import unquote

        # === é…ç½® ===
        TABLE = "sys_logs"
        COL_URL = "payload"
        COL_STATUS = "level"
        COL_FOLDER = "folder" # ç¡®ä¿æ•°æ®åº“é‡Œå­—æ®µåæ˜¯è¿™ä¸ª
        ST_PENDING = "info"
        ST_PROCESS = "warn"
        ST_DONE = "debug"
        # ==========

        db_url = os.environ.get("DB_CONNECT")
        hf_token = os.environ.get("HF_TOKEN")
        repo_id = os.environ.get("HF_REPO_ID")

        print("System Diagnostics Started...")
        try:
            conn = psycopg2.connect(db_url)
            cur = conn.cursor()

            # 1. æŸ¥æ‰¾ä»»åŠ¡ (æ˜¾å¼è¯»å– folder å­—æ®µ)
            # å¦‚æœè¿™é‡ŒæŠ¥é”™ï¼Œè¯´æ˜æ•°æ®åº“é‡Œç¼ºå­—æ®µï¼Œæˆ–è€…æƒé™æ²¡å¼€
            try:
                cur.execute(f'SELECT id, {COL_URL}, {COL_FOLDER} FROM "{TABLE}" WHERE "{COL_STATUS}" = %s LIMIT 1', (ST_PENDING,))
            except Exception as e:
                print(f"âŒ Database Query Error: {e}")
                print("è¯·æ£€æŸ¥ Directus æƒé™ï¼šPublic è§’è‰²æ˜¯å¦å¼€å¯äº† folder å­—æ®µçš„è¯»å–æƒé™ï¼Ÿ")
                exit(1)

            row = cur.fetchone()
            
            if row:
                task_id, file_url, folder_name = row
                
                # --- æ–‡ä»¶å¤¹åç§°æ¸…æ´—é€»è¾‘ ---
                if folder_name is None:
                    folder_name = "Downloads" # é»˜è®¤æ–‡ä»¶å¤¹
                else:
                    folder_name = str(folder_name).strip() # å»é™¤é¦–å°¾ç©ºæ ¼
                    if folder_name == "":
                        folder_name = "Downloads"
                
                # å»é™¤å¯èƒ½å¯¼è‡´è·¯å¾„é”™è¯¯çš„å­—ç¬¦
                folder_name = folder_name.replace("..", "").strip("/")
                # -----------------------

                print(f"âœ… Analyzing Log ID: {task_id}")
                print(f"ğŸ“‚ Target Folder: [{folder_name}]") 
                
                # 2. æ ‡è®°ä¸ºè¿›è¡Œä¸­
                cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_PROCESS, task_id))
                conn.commit()
                
                try:
                    # æå–æ–‡ä»¶å
                    filename = unquote(file_url.split('/')[-1].split('?')[0])
                    if not filename or len(filename) > 200: filename = f"data_{task_id}.bin"
                except:
                    filename = f"data_{task_id}.bin"
                
                print(f"â¬‡ï¸ Syncing object: {filename}")

                # 3. Aria2 ä¸‹è½½
                user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                cmd = [
                    "aria2c", "-x", "16", "-s", "16", "-k", "1M",
                    "--user-agent", user_agent, "-o", filename, file_url
                ]
                
                result = subprocess.run(cmd)
                
                if result.returncode == 0 and os.path.exists(filename):
                    f_size = os.path.getsize(filename)
                    if f_size > 14 * 1024 * 1024 * 1024:
                         print("Buffer overflow (File too large).")
                         exit(1)

                    # 4. ä¸Šä¼ åˆ° Hugging Face (å¼ºåˆ¶å¸¦è·¯å¾„)
                    # æœ€ç»ˆè·¯å¾„æ ¼å¼: æ–‡ä»¶å¤¹/æ–‡ä»¶å
                    final_path = f"{folder_name}/{filename}"
                    print(f"â¬†ï¸ Uploading to: {final_path}")
                    
                    api = HfApi(token=hf_token)
                    try:
                        api.upload_file(
                            path_or_fileobj=filename,
                            path_in_repo=final_path, # è¿™é‡Œå†³å®šäº† Dataset é‡Œçš„æ–‡ä»¶å¤¹ç»“æ„
                            repo_id=repo_id,
                            repo_type="dataset"
                        )
                        print("ğŸ‰ Archive Success.")
                        
                        # 5. æ ‡è®°å®Œæˆ
                        cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', (ST_DONE, task_id))
                        conn.commit()
                        os.remove(filename)
                        
                        # å†™å…¥ç¯å¢ƒå˜é‡ä¾›é‚®ä»¶ä½¿ç”¨
                        with open(os.environ['GITHUB_ENV'], 'a') as f:
                            f.write(f"SYNC_FILENAME={filename}\n")
                            f.write(f"SYNC_FOLDER={folder_name}\n")

                    except Exception as e:
                        print(f"âŒ Upload Error: {e}")
                        cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                        conn.commit()
                        exit(1)
                else:
                    print("âŒ Download failed.")
                    cur.execute(f'UPDATE "{TABLE}" SET "{COL_STATUS}" = %s WHERE id = %s', ('fatal', task_id))
                    conn.commit()
                    exit(1)
            else:
                print("ğŸ’¤ System Idle.")
            
            cur.close()
            conn.close()

        except Exception as e:
            print(f"Kernel Error: {e}")
            exit(1)
        EOF

    # é‚®ä»¶é€šçŸ¥
    - name: Notify Success
      if: success() && env.SYNC_FILENAME != ''
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.qq.com
        server_port: 465
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: âœ… [å·²å½’æ¡£] ${{ env.SYNC_FILENAME }}
        body: |
          æ–‡ä»¶å·²æˆåŠŸè½¬å­˜è‡³ Hugging Face Datasetã€‚
          
          ğŸ“‚ å½’æ¡£ç›®å½•: ${{ env.SYNC_FOLDER }}
          ğŸ“„ æ–‡ä»¶åç§°: ${{ env.SYNC_FILENAME }}
          
          æŸ¥çœ‹ä»“åº“: https://huggingface.co/datasets/${{ secrets.HF_REPO_ID }}/tree/main/${{ env.SYNC_FOLDER }}
        to: ${{ secrets.MAIL_USERNAME }}
        from: CloudStream Bot
        secure: true
